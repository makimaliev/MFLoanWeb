<div xmlns:th="http://www.w3.org/1999/xhtml" xmlns:sec="http://www.w3.org/1999/xhtml">
    <div class="modal-content">
        <!--begin::Form-->
        <form id="editForm" th:action="@{/collectionphase/save}" th:object="${phase}" method="post" class="m-form m-form--fit m-form--label-align-right">

            <div class="modal-body">
                <input type="hidden" th:field="*{id}"/>
                <div class="m-portlet__body">
                    <div class="m-form__section">

                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-4 col-sm-12">
                                <span th:text="#{label.collection.phase.startDate}"></span>
                            </label>
                            <div class="col-lg-4 col-md-9 col-sm-12">
                                <div class="input-group date m_datetimepicker_6">
                                    <input type="text" class="form-control m-input"  th:placeholder="#{label.select.date}" th:field="*{startDate}"/>
                                    <span class="input-group-addon">
                                                        <i class="la la-calendar glyphicon-th"></i>
                                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-4 col-sm-12">
                                <span th:text="#{label.collection.phase.type}"></span>
                                <span class="m--font-danger">*</span>
                            </label>
                            <div class="col-lg-4 col-md-9 col-sm-12">
                                <select class="form-control m-bootstrap-select m_selectpicker" th:field="*{phaseType}">
                                    <option th:each="type : ${types}" th:value="${type.id}" th:text="${type.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group m-form__group row">
                            <label class="col-form-label col-lg-4 col-sm-12" th:text="#{label.collection.phase.docNumber}">
                                <span class="m--font-danger">*</span>
                            </label>
                            <div class="col-lg-4 col-md-9 col-sm-12">
                                <input type="text" class="form-control m-input" th:field="*{docNumber}">
                            </div>
                        </div>

                        <div id="phaseDetailsTable" class="m_datatable"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button onclick="editPhase()" type="button" class="btn btn-default" data-dismiss="modal">Save</button>
            </div>
        </form>
        <!--end::Form-->
    </div>
    <!--end Modal-->
    <!--begin::Page Resources -->
    <script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-datetimepicker.js}" type="text/javascript"></script>
    <script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-select.js}" type="text/javascript"></script>
    <!--end::Page Resources -->
    <script th:inline="javascript">

        var loans = /*[[${loanIds}]]*/ [];
        var phaseLoanIds=JSON.stringify(loans);

        var newPhaseDetailsTableInit = function (jsonInput) {

            var dataJSONArray = JSON.parse(jsonInput);

            var datatable = $('#phaseDetailsTable').mDatatable({
                // datasource definition
                data: {
                    type: 'local',
                    source: dataJSONArray,
                    pageSize: 10
                },

                // layout definition
                layout: {
                    theme: 'default', // datatable theme
                    class: '', // custom wrapper class
                    scroll: false, // enable/disable datatable scroll both horizontal and vertical when needed.
                    footer: false // display/hide footer
                },

                // column sorting(refer to Kendo UI)
                sortable: true,

                // column based filtering(refer to Kendo UI)
                filterable: false,

                pagination: false,

                // inline and bactch editing(cooming soon)
                // editable: false,

                // columns definition
                columns: [{
                    field: "loanId",
                    title: "#",
                    sortable: false, // disable sort for this column
                    width: 50,
                    textAlign: 'center'
                }, {
                    field: "loanRegNumber",
                    sortable: 'asc',
                    title: "Регистрационный номер",
                    responsive: {visible: 'lg'}
                }, {
                    field: "startPrincipal",
                    title: "По осн.с.",
                    template: function (row) {
                        return '\
						<input type="text" class="form-control m-input" id="startPrinc' + row.loanId + '" value="' + (row.startPrincipal).toFixed(2)+ '">\
					';

                    }
                }, {
                    field: "startInterest",
                    title: "По проц.",
                    template: function (row) {
                        return '\
						<input type="text" class="form-control m-input" id="startInt' + row.loanId + '" value="' + (row.startInterest).toFixed(2)+ '">\
					';
                    }
                }, {
                    field: "startPenalty",
                    title: "По штр.",
                    template: function (row) {
                        return '\
						<input type="text" class="form-control m-input" id="startPen' + row.loanId + '" value="' + (row.startPenalty).toFixed(2)+ '">\
					';
                    }
                }, {
                    field: "startTotalAmount",
                    title: "Итого",
                    width: 160,
                    template: function (row) {
                        return '\
						<input type="text" class="form-control m-input" id="total' + row.loanId + '" value="' + (row.startTotalAmount).toFixed(2)+ '" disabled>\
					';
                    }
                }],
                translate: {
                    records: {
                        processing: 'Подождите пожалуйста...',
                        noRecords: 'Записей не найдено'
                    },
                    toolbar: {
                        pagination: {
                            items: {
                                default: {
                                    first: 'Первая страница',
                                    prev: 'Предыдущая страница',
                                    next: 'Следующая страница',
                                    last: 'Последняя страница',
                                    more: 'Другие страницы',
                                    input: 'Номер страницы',
                                    select: 'Выбрать размер страницы'
                                },
                                info: 'Отображение {{start}} - {{end}} из {{total}} записей'
                            }
                        }
                    }
                }
            });
        }

        $.ajax({
            type : 'POST',
            url : "/collectionPhase/"+pId+"/getPhaseDetails",
            data: {selectedLoans:phaseLoanIds},
            success:function (data) {
                // alert(data)
                newPhaseDetailsTableInit(data);
                var data = JSON.parse(data);
                // console.log(data)
                var saver=function(){
                    var phaseDetailsModels = [];
                    for (var i = 0; i < data.length; i++) {
                        var obj = data[i];
                        $.map(obj, function(val, key) {
                            if(key=='loanId')
                            {
                                var PhaseDetailsModel = {};
                                var startPrincInput ="#startPrinc" + val;
                                var startIntInput ="#startInt" + val;
                                var startPenInput ="#startPen" + val;
                                var totalInput = "#total" + val;

                                PhaseDetailsModel['loanId'] = val;
                                PhaseDetailsModel['startPrincipal'] = parseFloat($(startPrincInput).val());
                                PhaseDetailsModel['startInterest'] = parseFloat($(startIntInput).val());
                                PhaseDetailsModel['startPenalty'] = parseFloat($(startPenInput).val());
                                PhaseDetailsModel['startTotalAmount'] = parseFloat($(totalInput).val());
                                // PhaseDetailsModel['initDate'] = d;
                                phaseDetailsModels.push(PhaseDetailsModel);
                            }
                        });
                        console.log(phaseDetailsModels);
                    }
                    // console.log(phaseDetailsModels);
                    phaseDetailsModels = JSON.stringify({
                        'phaseDetailsModels' : phaseDetailsModels
                    });
                    $.ajax({
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        type : 'POST',
                        url : "/collectionPhase/savePhaseDetails",
                        data: phaseDetailsModels,
                        dataType: 'json'
                    });
                }
                for (var i = 0; i < data.length; i++) {
                    var obj = data[i];
                    $.map(obj, function(val, key) {

                        if(key=="loanId"){
                            // alert(key+" : "+val);
                            var startPrincInput ="#startPrinc" + val;
                            var startIntInput ="#startInt" + val;
                            var startPenInput ="#startPen" + val;
                            var totalInput = "#total" + val;

                            $(startPrincInput).on('input', function () {
                                if($(startPrincInput).val()[$(startPrincInput).val()-1]!='.')
                                    updateTotal();
                            });

                            $(startIntInput).on('input', function () {
                                if($(startIntInput).val()[$(startIntInput).val()-1]!='.')
                                    updateTotal();
                            });

                            $(startPenInput).on('input', function () {
                                if($(startPenInput).val()[$(startPenInput).val()-1]!='.')
                                    updateTotal();
                            });

                            function updateTotal() {
                                var sum = 0.0;
                                sum = ((parseFloat($(startPrincInput).val()) + parseFloat($(startIntInput).val()) + parseFloat($(startPenInput).val())));
                                $(totalInput).val(sum.toFixed(2));
                                saver();
                            }
                        }
                    });
                }
                // var divT = $('#phaseDetailsDiv');
                // divT.collapse('show');
                // mApp.scrollTo(divT, -200);
            }
        });

        function editPhase() {
            $.ajax({
                type: 'POST',
                data: $('#editForm').serialize(),
                url: $('#editForm').attr('action'),
                success: function(data) {
                    reloadContent();
                },
            });
        }
    </script>
</div>