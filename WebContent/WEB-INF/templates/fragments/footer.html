<div th:fragment="footer-js">
    <!--begin::Base Scripts -->
    <script th:src="@{/assets/custom/vendors/base/vendors.bundle.js}" type="text/javascript"></script>
    <script th:src="@{/assets/custom/demo/default/base/scripts.bundle.js}" type="text/javascript"></script>
    <!--end::Base Scripts -->

    <script th:src="@{/js/sockjs.js}" type="text/javascript"></script>
    <script th:src="@{/js/stomp.js}" type="text/javascript"></script>

    <script>

        // Chat Begin
        var messageForm = document.querySelector('#messageForm');
        var messageInput = document.querySelector('#message');
        var messageArea = document.querySelector('#messageArea');
        var userSearch = document.querySelector('#usersearch');
        var userList = document.querySelector('#userlist');
        var chatModalTitle = document.querySelector('#chatModalTitle');
        var stompClient = null;
        var username = "[[${#authentication.name}]]";
        var receiver = null;
        var prevdate = null;

        function connect() {
            var socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.connect({}, onConnected, onError);
        }
        function onConnected() {
            stompClient.subscribe('/topic/public', onMessageReceived);
            stompClient.send("/app/chat.addUser", {}, JSON.stringify({sender: username, type: 'JOIN'}))
        }
        function sendMessage(event) {
            var messageContent = messageInput.value.trim();

            if(messageContent && stompClient && receiver) {
                var chatMessage = {
                    sender: username,
                    receiver: receiver,
                    content: messageInput.value,
                    type: 'CHAT'
                };

                stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
                messageInput.value = '';
            }
            event.preventDefault();
        }
        function buildMessage(message) {

            var curdate = new Date(message.date).toLocaleDateString("ru", {day:"2-digit", month:"2-digit", year:"2-digit"});

            if((prevdate == null) || (prevdate < curdate))
            {
                prevdate = new Date(message.date).toLocaleDateString("ru", {day:"2-digit", month:"2-digit", year:"2-digit"});

                var dtContainer = document.createElement('div');
                    dtContainer.classList.add('center');

                var dt = document.createElement('span');
                    dt.classList.add('date-title');

                var dttxt = document.createTextNode(prevdate);
                    dt.appendChild(dttxt);

                    dtContainer.appendChild(dt);

                messageArea.appendChild(dtContainer);
            }

            var mc = document.createElement('div');
                mc.classList.add('message');
            var mctxt = document.createTextNode(message.content);
                mc.appendChild(mctxt);

            var s2 = document.createElement('span');
            var d = new Date(message.date);
            var s2txt = document.createTextNode(d.toLocaleTimeString([], {hour12: false, hour: '2-digit', minute:'2-digit'}));
                s2.appendChild(s2txt);

            var s1 = document.createElement('span');
                s1.classList.add('metadata');
                s1.appendChild(s2);
                mc.appendChild(s1);

            if(message.sender === username)
            {
                mc.classList.add('sent');
            }
            else
            {
                mc.classList.add('received');
            }

            messageArea.appendChild(mc);
            messageArea.scrollTop = messageArea.scrollHeight;
        }
        function onMessageReceived(payload) {

            var message = JSON.parse(payload.body);

            if(message.type === 'CHAT')
            {
                buildMessage(message);
            }
        }
        function onError() {}
        function searchUser() {

            var filter, usr, uid, i;

            filter = userSearch.value.toUpperCase();
            usr = userList.getElementsByTagName('tr');

            for (i = 0; i < usr.length; i++) {
                uid = usr[i].getElementsByTagName("td")[0];
                if (uid.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    usr[i].style.display = "";
                } else {
                    usr[i].style.display = "none";
                }
            }
        }

        $("#userlist tr td").click(function() {

            if(receiver !== this.id)
            {
                messageArea.innerHTML = "";
                chatModalTitle.innerHTML = this.innerText;

                $("#" + receiver).removeClass();
                receiver = this.id;
                $("#" + receiver).addClass("bg-info text-white");

                $("#userlist tr").removeAttr("style");
                prevdate = null;
                $.ajax({
                    type: "POST",
                    url: "/chat/messages",
                    data: { sender: username, receiver: receiver },
                    success: function(result){
                        for(var i = 0; i < result.length; i++)
                        {
                            buildMessage(result[i]);
                        }
                    }
                });
                this.scrollTop = this.scrollHeight;
            }
        });
        $('#chat_window').on('hidden.bs.modal', function (e) {

            receiver = null;
            messageArea.innerHTML = "";
            chatModalTitle.innerHTML = "";

            $("#userlist tr").removeAttr("style");
            $("#userlist tr td").removeClass();
        });
        $('#chat_window').on('show.bs.modal', function (e) {

            connect();
        });

        messageForm.addEventListener('submit', sendMessage, true);
        // Chat End

        function changePageAndSize() {
            $('#pageSizeSelect').change(function(evt) {
                var currentLocation = window.location.pathname;
                window.location.replace(currentLocation + "?pageSize=" + this.value + "&page=1");
            });
        }

        $(document).ready(function() {
            changePageAndSize();
        });


    </script>



</div>