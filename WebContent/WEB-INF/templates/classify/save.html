<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<!-- begin::Head -->
<head>
	<title th:text="#{label.classification.add}"></title>

	<div th:replace="fragments/header :: header-css"/>
</head>
<!-- end::Head -->

<!-- end::Body -->
<body class="m-page--fluid m--skin- m-content--skin-light2 m-header--fixed m-header--fixed-mobile m-aside-left--enabled m-aside-left--skin-dark m-aside-left--offcanvas m-footer--push m-aside--offcanvas-default"  >
<!-- begin:: Page -->
<div class="m-grid m-grid--hor m-grid--root m-page">
	<!-- BEGIN: Header -->
	<div th:replace="layout/header"/>
	<!-- END: Header -->
	<!-- begin::Body -->
	<div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
		<!-- BEGIN: Left Aside -->
		<div th:replace="layout/sidebar"/>
		<!-- END: Left Aside -->
		<div class="m-grid__item m-grid__item--fluid m-wrapper">
			<div class="m-content">
				<!--begin::Portlet-->
				<div class="m-portlet m-portlet--full-height">
					<div class="m-portlet__head">
						<div class="m-portlet__head-caption">
							<div class="m-portlet__head-title">
								<h3 class="m-portlet__head-text" th:text="#{label.add.classification.title}"></h3>
							</div>
						</div>
					</div>
					<!--begin::Form-->
					<form th:action="@{/classify/save}" th:object="${classificationForm}" method="post" class="m-form m-form--fit m-form--label-align-right">

						<div class="m-portlet__body">
							<div class="m-form__section">

                                <div>
                                    <div>
                                        Choose view:
                                        <select id="selectedView" th:field="*{viewName}">
                                            <option value="">--Select item--</option>
                                            <option th:each="name : ${viewNames}" th:value="${{name}}" th:text="${name}"></option>
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div id="mainContainer">
                                    <div id="addContainer">
                                        <button type="button" id="addFilter">Add filter</button>
                                    </div>
                                    <div id="inputValues">
                                    </div>
                                    <!--
                                    <div id="saveContainer">
                                        <button disabled="true" type="button" id="saveAll">Save classification</button>
                                    </div>
                                    -->
                                </div>

                                <!--

                                <div>
                                    <div>
                                        Choose field:
                                        <select id="selectedField" th:field="*{fieldName}" th:title="#{label.select}">
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <div>
                                        <button type="button">Add value filter</button>
                                        <button type="button">Add range filter</button>
                                    </div>
                                </div>
                                -->


							</div>
						</div>

						<div class="m-portlet__foot m-portlet__foot--fit">
							<div class="m-form__actions m-form__actions">
								<div class="row">
									<div class="col-lg-4"></div>
									<div class="col-lg-6">
										<button type="button" class="btn btn-primary">
											Generate Query
										</button>
										<!--
                                        <button onclick="window.history.back()" type="button" class="btn btn-secondary" th:text="#{label.add.debtor.cancel}">
											Cancel
										</button>
										-->
									</div>
								</div>
							</div>
						</div>

                    </form>
					<!--end::Form-->
				</div>
				<!--end::Portlet-->
			</div>
        </div>
    </div>
    <!-- end:: Body -->
    <!-- begin::Footer -->
    <div th:replace="layout/footer"/>
    <!-- end::Footer -->
</div>
<!-- end:: Page -->

<div th:replace="fragments/footer :: footer-js"/>

<!--begin::Page Resources -->
<script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-datetimepicker.js}" type="text/javascript"></script>
<script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-select.js}" type="text/javascript"></script>
<!--end::Page Resources -->
<script type="text/javascript">
    $(document).ready(function(){

        var fieldNames = {};
        var tempFieldNames = {};
        var inputDiv = $('#inputValues');
        var i = 1;

        //disable add filter button initially
        disableEnableAddFilter(fieldNames, tempFieldNames);

        $('#selectedView').change(
            function() {
                fieldNames = {};
                tempFieldNames = {};
                $.getJSON("/classify/fields", {
                    viewName : $(this).val(),
                    ajax : 'true'
                }, function(data) {
                    var html = '';
                    for ( var i = 0; i < data.length; i++) {
                        fieldNames[data[i].fieldName] = data[i].fieldType;
                    }
                    //enable add filter button
                    disableEnableAddFilter(fieldNames, tempFieldNames);
                });
            });

        $('#addFilter').on('click', function() {

            var options = '';

            for (var item in fieldNames) {
                options = options + '<option value="' + item + '">'+ item + '</option>';
            }

            console.log(options);

            var tag = '<div id="temp'+ i +'">' +
                '<select id="fieldNames'+ i +'">' +
                options +
                '</select>' +
                '<select id="operators">' +
                '<option value="eq">=</option>' +
                '<option value="neq">!=</option>' +
                '<option value="gt">></option>' +
                '<option value="st"><</option>' +
                '</select>' +
                '<input type="text" value="" id="input'+ i + '"/>' +
                '<button id="checkFilter'+ i + '" type="button">&#9989;</button>' +
                '</div>' +
                '</div>';

            $(tag).appendTo(inputDiv);
            createRemoveFunction(i, tempFieldNames, fieldNames);
            var optionText = $('#fieldNames' + i + ' option:selected').text();
            console.log(optionText);
            i++;
            console.log(i);
            return false;
        });
    });

    function createRemoveFunction(i, temp, orig) {
        $(document).on('click','#checkFilter' + i,function() {
            console.log(this);
            $(this).text('X');
            $(this).attr('id', 'removeFilter' + i);
            var optionText = $('#fieldNames' + i + ' option:selected').text();
            console.log(optionText);
            temp[optionText] = orig[optionText];
            delete orig[optionText];
            filterChecked(i, temp, orig, optionText);
            console.log(temp);
            return false;
        });
    }

    function filterChecked(i, temp, orig, key) {
        disableEnableAddFilter(orig, temp);
        $(document).on('click','#removeFilter' + i,function() {
            orig[key] = temp[key];
            delete temp[key];
            $('#temp' + i).remove();
            i--;
            disableEnableAddFilter(orig, temp);
            return false;
        });
    }

    function disableEnableAddFilter(orig, temp) {
        var len1 = Object.keys(orig).length;
        var len2 = Object.keys(temp).length;
        console.log(orig);
        console.log(temp);

        if(len1 <= 0)
        {
            $('#addFilter').attr("disabled", true);
        }
        else
        {
            $('#addFilter').removeAttr("disabled");
        }
    }

</script>
</body>
<!-- end::Body -->
</html>