<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<!-- begin::Head -->
<head>
	<title th:text="#{label.classification.add}"></title>

	<div th:replace="fragments/header :: header-css"/>
</head>
<!-- end::Head -->

<!-- end::Body -->
<body class="m-page--fluid m--skin- m-content--skin-light2 m-header--fixed m-header--fixed-mobile m-aside-left--enabled m-aside-left--skin-dark m-aside-left--offcanvas m-footer--push m-aside--offcanvas-default"  >
<!-- begin:: Page -->
<div class="m-grid m-grid--hor m-grid--root m-page">
	<!-- BEGIN: Header -->
	<div th:replace="layout/header"/>
	<!-- END: Header -->
	<!-- begin::Body -->
	<div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
		<!-- BEGIN: Left Aside -->
		<div th:replace="layout/sidebar"/>
		<!-- END: Left Aside -->
		<div class="m-grid__item m-grid__item--fluid m-wrapper">
			<div class="m-content">
				<!--begin::Portlet-->
				<div class="m-portlet m-portlet--full-height">
					<div class="m-portlet__head">
						<div class="m-portlet__head-caption">
							<div class="m-portlet__head-title">
								<h3 class="m-portlet__head-text" th:text="#{label.add.classification.title}"></h3>
							</div>
						</div>
					</div>
					<!--begin::Form-->
					<form th:action="@{/classify/save}" th:object="${classificationForm}" method="post" class="m-form m-form--fit m-form--label-align-right">

						<div class="m-portlet__body">
							<div class="m-form__section">

                                <div>
                                    <div>
                                        Choose view:
                                        <select id="selectedView" th:field="*{viewName}">
                                            <option value="">--Select item--</option>
                                            <option th:each="name : ${viewNames}" th:value="${{name}}" th:text="${name}"></option>
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div id="mainContainer">
                                    <div id="chooseField">
                                    </div>
                                    <div id="addContainer">
                                        <button type="button" id="addFilter">Add filter</button>
                                    </div>
                                    <div id="inputValues">
                                    </div>
                                    <div id="generateContainer">
                                        <br>
                                        <div>
                                            <button type="button" id="generateQuery">Generate query</button>
                                        </div>
                                        <div>
                                            <textarea rows="4" cols="50" id="queryText"></textarea>
                                        </div>
                                        <br>
                                        <div>
                                            <button type="button" id="calcPercentage">Calculate percentage</button>
                                        </div>
                                        <div>
                                            <textarea rows="1" cols="50" id="outputPercentage"></textarea>
                                        </div>
                                    </div>
                                </div>
							</div>
						</div>
                    </form>
					<!--end::Form-->
				</div>
				<!--end::Portlet-->
			</div>
        </div>
    </div>
    <!-- end:: Body -->
    <!-- begin::Footer -->
    <div th:replace="layout/footer"/>
    <!-- end::Footer -->
</div>
<!-- end:: Page -->

<div th:replace="fragments/footer :: footer-js"/>

<!--begin::Page Resources -->
<script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-datetimepicker.js}" type="text/javascript"></script>
<script th:src="@{/assets/custom/demo/default/custom/components/forms/widgets/bootstrap-select.js}" type="text/javascript"></script>
<!--end::Page Resources -->
<script type="text/javascript">
    $(document).ready(function(){

        var tags = {};
        var orButtonTags = {};
        var fieldNames = {};
        var inputDiv = $('#inputValues');
        var chooseFieldDiv = $('#chooseField');
        var i = 1;

        //disable add filter button initially
        disableEnableAddFilter(fieldNames, tags);

        $('#selectedView').change(
            function() {
                fieldNames = {};
                for (var item in tags) {
                    $('#temp' + item).remove();
                }
                tags = {};

                for (var t in orButtonTags) {
                    $('#orButton' + t).remove();
                }
                orButtonTags = {};

                $('#selectedField').remove();

                $('#addFilter').attr("hidden", true);

                var selectedItem = $(this).val();

                if(selectedItem.length > 0)
                {
                    $.getJSON("/classify/fields", {
                        viewName : $(this).val(),
                        ajax : 'true'
                    }, function(data) {
                        for ( var i = 0; i < data.length; i++) {
                            fieldNames[data[i].fieldName] = data[i].fieldType;
                        }

                        addChooseField(fieldNames, chooseFieldDiv);
                        //enable add filter button
                        disableEnableAddFilter(fieldNames, tags);
                    });
                }
            });

        $('#addFilter').on('click', function() {

            var options = '';

            for (var item in fieldNames) {
                options = options + '<option value="' + item + '">'+ item + '</option>';
            }

            var tag = '';

            var tagsSize = Object.keys(tags).length;

            if(tagsSize > 0)
            {
                tag = tag + '<div id="orButton'+ i +'">' +
                    '<button id="btnOR'+ i + '" type="button">AND</button>' +
                    '</div>';
            }

            tag =  tag + '<div id="temp'+ i +'">' +
                '<select id="fieldNames'+ i +'">' +
                options +
                '</select>' +
                '<select id="operators' + i +'">' +
                '<option value="eq">=</option>' +
                '<option value="neq">!=</option>' +
                '<option value="gt">></option>' +
                '<option value="gte">>=</option>' +
                '<option value="lt"><</option>' +
                '<option value="lte"><=</option>' +
                '</select>' +
                '<input type="text" value="" id="input'+ i + '"/>' +
                '<button id="checkFilter'+ i + '" type="button">&#9989;</button>' +
                '</div>' +
                '</div>';

            $(tag).appendTo(inputDiv);
            createRemoveFunction(i, fieldNames, tags);
            createOnChangeFunction(i, fieldNames);
            createOrButtons(i, orButtonTags);
            changeInputType(i, fieldNames);
            tags[i] = i;
            i++;
            return false;
        });

        $('#generateQuery').on('click', function() {

            //console.log(tags);
            //console.log(fieldNames);

            var txt = 'SELECT ' +
                $('#selectedField option:selected').text()+
                ' FROM ';
            txt = txt + $('#selectedView option:selected').text() + '\n';
            txt = txt + 'WHERE ';

            var tagsCount = 0;

            for (var item in tags) {
                if(tagsCount > 0){
                    if(orButtonTags.hasOwnProperty(item))
                        txt = txt + ' OR ';
                    else
                        txt = txt + ' AND ';
                }

                txt = txt + $('#fieldNames' + item + ' option:selected').text();
                txt = txt + $('#operators' + item + ' option:selected').text();
                txt = txt + wrapValue(item, fieldNames);
                tagsCount++;
            }

            txt = txt + ';';
            $('#queryText').val(txt);
            return false;
        });

        $('#calcPercentage').on('click', function() {

            var selectedField = $('#selectedField option:selected').text();
            var selectedView = $('#selectedView option:selected').text();

            var query = $('#queryText').val();

            console.log(selectedField);
            console.log(selectedView);
            console.log(query);

            var calcValues = {};
            calcValues['field'] = selectedField;
            calcValues['viewName'] = selectedView;
            calcValues['query'] = query;

            $.getJSON("/classify/calcPercentage", {
                data : JSON.stringify(calcValues),
                ajax : 'true'
            }, function(data) {
                $('#outputPercentage').val(data + '%');
            });

            return false;
        });

    });

    function addChooseField(orig, divSelected)
    {
        var temp = '';

        for (var t in orig) {
            temp = temp + '<option value="' + t + '">'+ t + '</option>';
        }

        var tTag = '<select id="selectedField">' +
            temp +
            '</select>';

        $(tTag).appendTo(divSelected);
    }

    function createRemoveFunction(i, orig, tags) {
        $(document).on('click','#checkFilter' + i,function() {
            $(this).text('X');
            $(this).attr('id', 'removeFilter' + i);
            var optionText = $('#fieldNames' + i + ' option:selected').text();
            filterChecked(i, orig, optionText, tags);
            return false;
        });
    }

    function filterChecked(i, orig, key, tags) {
        disableEnableAddFilter(orig, tags);
        $(document).on('click','#removeFilter' + i,function() {
            $('#temp' + i).remove();
            $('#orButton' + i).remove();
            delete tags[i];
            i--;
            disableEnableAddFilter(orig, tags);
            return false;
        });
    }

    function createOnChangeFunction(i, orig) {
        $('#fieldNames'+i).change(
            function() {
                changeInputType(i, orig)
            return false;
        });
    }

    function createOrButtons(i, buttonTags) {
        $(document).on('click','#btnOR' + i,function() {
            //console.log(buttonTags);

            if (buttonTags.hasOwnProperty(i)) {
                $('#btnOR' + i).html('AND');
                delete buttonTags[i];
            }
            else {
                $('#btnOR' + i).html('OR');
                //$('#btnOR' + i).css('font-weight', 'bold');
                buttonTags[i] = i;
            }
            return false;
        });
    }

    function disableEnableAddFilter(orig, tags) {
        var sizeOrig = Object.keys(orig).length;
        var sizeTags = Object.keys(tags).length;

        if(sizeOrig == 0)
        {
            $('#addFilter').attr("hidden", true);
            $('#generateContainer').attr("hidden", true);
            $('#queryText').val('');
        }

        if(sizeOrig > 0)
        {
            $('#addFilter').removeAttr("hidden");
        }

        if(sizeTags == 0)
        {
            $('#generateContainer').attr("hidden", true);
            $('#queryText').val('');
        }

        if(sizeTags > 0)
        {
            $('#generateContainer').removeAttr("hidden");
        }

    }

    function changeInputType(i, orig)
    {
        var optionText = $('#fieldNames' + i + ' option:selected').text();
        var type = orig[optionText];
        //console.log(type);
        if(type == 'bigint(20)')
        {
            $('#input' + i).attr("type", "text");
        }
        else if(type == 'date')
        {
            $('#input' + i).attr("type", "date");
        }
        else
        {
            $('#input' + i).attr("type", "text");
        }

        return false;
    }

    function wrapValue(item, orig)
    {
        var result = '';
        var optionText = $('#fieldNames' + item + ' option:selected').text();
        var type = orig[optionText];
        var inputVal=$('#input' + item).val();

        if(type == 'bigint(20)')
        {
            result = inputVal;
        }
        else if(type == 'date')
        {
            result = '\'' + inputVal + '\'';
        }
        else if(type.match("^varchar"))
        {
            result = '\'' + inputVal + '\'';
        }
        else
        {
            result = inputVal;
        }

        return result;
    }

</script>
</body>
<!-- end::Body -->
</html>