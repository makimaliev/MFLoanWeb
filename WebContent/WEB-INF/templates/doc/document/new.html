<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>MFLoan | Docflow</title>

    <div th:replace="fragments/header :: header-css"></div>

</head>
<body class="page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid page-sidebar-closed">

<div th:replace="layout :: header-top"></div>

<div class="page-container">

    <div th:replace="layout :: page-container-sidebar" />

    <div class="page-content-wrapper">
        <div class="page-content">

            <!-- Content goes here -->
            <form action="#" id="form" method="post" class="form-horizontal" th:object="${document}">

                <input type="hidden" value="" th:field="*{id}"/>
                <input type="hidden" value="" th:field="*{documentType.id}"/>
                <input type="hidden" value="" th:field="*{documentSubType.id}"/>
                <input type="hidden" value="" th:field="*{senderStatus}"/>

                <!--input type="hidden" value="" th:field="*{senderResponsible.staff.id}" name="senderResponsible.staff.id"/>
                <input type="hidden" value="" th:field="*{senderResponsible.department.id}" name="senderResponsible.department.id"/>
                <input type="hidden" value="" th:field="*{senderResponsible.organization.id}" name="senderResponsible.organization.id"/>
                <input type="hidden" value="" th:field="*{senderResponsible.person.id}" name="senderResponsible.person.id"/-->

                <div class="form-body">

                    <div class="form-group">
                        <label class="control-label col-md-4">Title<span class="required"> * </span></label>
                        <div class="col-md-6">
                            <input th:field="*{title}" placeholder="Title" class="form-control" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-4">Description<span class="required"> * </span></label>
                        <div class="col-md-6">
                            <input th:field="*{description}" placeholder="Description" class="form-control" type="text">
                        </div>
                    </div>

                    <!-- ********************************************************************************************** -->
                    <div class="form-group">
                        <label class="control-label">Sender type<span class="required"> * </span></label>
                        <select class="form-control" id="sr" th:field="*{senderResponsible.responsibleType}">
                            <option th:each="r,i : ${responsibles}"
                                    th:value="${i.index + 1}"
                                    th:text="${r}">Responsible</option>
                        </select>
                    </div>


                    <div class="form-group" name="si1" >
                        <label class="control-label">Sender name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{senderResponsible.staff}">
                            <option th:each="p : ${staff}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="si2">
                        <label class="control-label">Sender name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{senderResponsible.departments}">
                            <option th:each="p : ${department}"
                                    th:value="${{p}}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="si3">
                        <label class="control-label">Sender name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{senderResponsible.organizations}">
                            <option th:each="p : ${organization}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="si4">
                        <label class="control-label">Sender name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{senderResponsible.person}">
                            <option th:each="p : ${person}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <!-- ********************************************************************************************** -->

                    <div class="form-group">
                        <label class="control-label">Receiver type<span class="required"> * </span></label>
                        <select class="form-control" id="rr" th:field="*{receiverResponsible.responsibleType}">
                            <option th:each="r,i : ${responsibles}"
                                    th:value="${i.index + 1}"
                                    th:text="${r}">Responsible</option>
                        </select>
                    </div>


                    <div class="form-group" name="ri1" >
                        <label class="control-label">Receiver name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{receiverResponsible.staff}">
                            <option th:each="p : ${staff}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="ri2">
                        <label class="control-label">Receiver name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{receiverResponsible.departments}">
                            <option th:each="p : ${department}"
                                    th:value="${{p}}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="ri3">
                        <label class="control-label">Receiver name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{receiverResponsible.organizations}">
                            <option th:each="p : ${organization}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <div class="form-group" name="ri4">
                        <label class="control-label">Receiver name<span class="required"> * </span></label>
                        <select class="form-control"  multiple="true" th:field="*{receiverResponsible.person}">
                            <option th:each="p : ${person}"
                                    th:value="${p.id}"
                                    th:text="${p.name}">Responsible</option>
                        </select>
                    </div>

                    <!-- ********************************************************************************************** -->


                </div>
            </form>

            <!-- Content goes here -->

        </div>
    </div>

</div>

<div th:replace="layout :: footer"></div>
<div th:replace="fragments/footer :: footer-js"></div>

<script th:src="@{/assets/global/plugins/datatables/datatables.js}" type="text/javascript"></script>
<script th:src="@{/assets/global/plugins/datatables/dataTables.keyTable.js}" type="text/javascript"></script>
<script th:inline="javascript">

    var table;
    var responsibles = [[${responsibles}]]

    var si = 0;
    var sitems = [
        $('[name="si1"]'),
        $('[name="si2"]'),
        $('[name="si3"]'),
        $('[name="si4"]')
    ];
    var ri = 0;
    var ritems = [
        $('[name="ri1"]'),
        $('[name="ri2"]'),
        $('[name="ri3"]'),
        $('[name="ri4"]')
    ];

    $(document).ready(function() {

        $('[name="si1"]').show();
        $('[name="si2"]').hide();
        $('[name="si3"]').hide();
        $('[name="si4"]').hide();

        $('[name="ri1"]').show();
        $('[name="ri2"]').hide();
        $('[name="ri3"]').hide();
        $('[name="ri4"]').hide();

        table = $("#documentTable").DataTable({
            "processing": true,
            "language": {"url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Russian.json"},
            "info":     false,
            "ajax": {
                "url" : "/MFLoanWeb/doc/" + [[${type}]],
                "dataSrc": ""
            },
            "columns": [
                { "data": "id" },
                { "data": "title" },
                { "data": "description" },
                { "data": "documentSubType.name" },
                { "data": function(data, type, row) {
                        return responsibles[data.senderResponsible.responsibleType - 1];
                    }
                },
                { "data": function(data, type, row) {
                        return responsibles[data.receiverResponsible.responsibleType - 1];
                    }
                },
                { "data": "id",
                    "render" : function(data, type, row) {
                        return "<a href='/MFLoanWeb/doc/view/" + data + "' role='button' class='btn btn-xs green-stripe'> View </a>"; }
                },
                { "data": "id",
                    "render" : function(data, type, row) {
                        return '<a data-toggle="modal" data-target="#modal_form" href="#" onclick="edit_document(' + data + ');" role="button" class="btn btn-xs blue-stripe"> Edit </a>'; }
                },
                { "data": "id",
                    "render" : function(data, type, row) {
                        return '<a href="#" onclick="delete_document(' + data + ');" role="button" class="btn btn-xs red-stripe"> Delete </a>'; }
                }
            ],
            keys: { focus: ':eq(0)' },

        });
    });
    function create_document(title, docsubtype) {

        $("#form")[0].reset();
        $('[name="document.id"]').val(0);
        $('[name="documentSubType.id"]').val(docsubtype);
        $('[name="documentType.id"]').val([[${documentTypeId}]]);

        formState(false, title);
    }
    function edit_document(id) {
        $("#form")[0].reset();
        $.ajax({
            url : "/MFLoanWeb/doc/" + id,
            type: "GET",
            dataType: "JSON",
            success: function(data) {
                formState(false, "Edit Document");
                loadData(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert("Error get data from ajax");
            }
        });
    }
    function delete_document(id) {
        if(confirm('Are you sure delete this data?'))
        {
            $.ajax({
                url : "/MFLoanWeb/doc/remove/" + id,
                type: "POST",
                dataType: "text",
                success: function(data)
                {
                    reload_table();
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    alert('Error deleting Document!');
                }
            });
        }
    }
    function save_document() {
        $.ajax({
            url : "/MFLoanWeb/doc/add",
            type: "POST",
            data: $('#form').serialize(),
            dataType: "text",
            success: function(data)
            {
                reload_table();
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert("Error saving Document");
            }
        });
        $("#documentModal").modal('hide');
    }
    function reload_table() {
        table.ajax.reload(null,false);
    }
    function loadData(item) {

        $('[name="id"]').val(item.id);
        $('[name="title"]').val(item.title);
        $('[name="description"]').val(item.description);
        $('[name="documentType.id"]').val(item.documentType.id);
        $('[name="documentSubType.id"]').val(item.documentSubType.id);

        $('[name="documentSubType.id"]').val(item.documentSubType.id);
    }
    function formState(state, mtitle) {

        $('[name="tabs"]').show();

        $('[name="title"]').attr('disabled', state);
        $('[name="description"]').attr('disabled', state);
        $('[name="documentType.id"]').attr('disabled', state);
        $('[name="documentSubType.id"]').attr('disabled', state);

        if(state) {
            $('#btnSave').hide();
        }
        else
        {
            $('#btnSave').show();
        }
        $(".modal-title").text(mtitle);
        $("#documentModal").modal('show');
    }

    function initSelectSender(itm) {

        if(itm != si)
        {
            sitems[si].hide();
            sitems[itm].show();
            si = itm;
        }

    }
    function initSelectReceiver(itm) {

        if(itm != ri)
        {
            ritems[ri].hide();
            ritems[itm].show();
            ri = itm;
        }

    }

    $("#sr").change(function() {
        var selection = $(this).val();
        initSelectSender(selection - 1);
    });
    $("#rr").change(function() {
        var selection = $(this).val();
        initSelectReceiver(selection - 1);
    });
    $("#documentModal").on("show.bs.modal", function(e) {
        var sr = $("#sr").val();
        initSelectSender(sr - 1);

        var rr = $("#rr").val();
        initSelectReceiver(rr - 1)

    });

</script>

</body>
</html>
