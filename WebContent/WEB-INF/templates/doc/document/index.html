<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<!-- begin::Head -->
<head>
    <title th:text="#{label.identityDocType.page.title}">Loan view</title>

    <div th:replace="fragments/header :: header-css"/>

    <style type="text/css" th:inline="text">
        .nopm {
            padding: 0;
            margin: 0;
        }
        .active-document {
            background: #d9d9d9;
        }
        td.details-control {
            background: url([[@{/doc/document/details_open.png}]]) no-repeat center center;
            cursor: pointer;
        }
        tr.details td.details-control {
            background: url([[@{/doc/document/details_close.png}]]) no-repeat center center;
        }
    </style>

</head>
<!-- end::Head -->
<!-- end::Body -->
<body class="m-page--fluid m--skin- m-content--skin-light2 m-header--fixed m-header--fixed-mobile m-aside-left--enabled m-aside-left--skin-dark m-aside-left--offcanvas m-footer--push m-aside--offcanvas-default m-aside-left--minimize m-brand--minimize"  >
<!-- begin:: Page -->
<div class="m-grid m-grid--hor m-grid--root m-page">
    <!-- BEGIN: Header -->
    <div th:replace="layout/header"/>
    <!-- END: Header -->

    <!-- begin::Body -->
    <div class="m-grid__item m-grid__item--fluid m-grid m-grid--ver-desktop m-grid--desktop m-body">
        <!-- BEGIN: Left Aside -->
        <div th:replace="layout/sidebar"/>
        <!-- END: Left Aside -->
        <div class="m-grid__item m-grid__item--fluid m-wrapper">

            <div class="m-content">
                <!--Begin Portlet-->
                <div class="m-portlet m-portlet--mobile">
                    <div class="m-portlet__head">
                        <div class="m-portlet__head-caption">
                            <div class="m-portlet__head-title">
                                <h3 class="m-portlet__head-text" th:text="${'Список документов : ' + title}"></h3>
                            </div>
                        </div>
                        <div class="m-portlet__head-tools">
                            <ul class="m-portlet__nav">
                                <li class="m-portlet__nav-item">
                                    <div class="m-input-icon m-input-icon--left">
                                        <input type="text" class="form-control m-input" th:placeholder="#{label.search}" id="generalSearch">
                                        <span class="m-input-icon__icon m-input-icon__icon--left">
                                            <span><i class="la la-search"></i></span>
                                        </span>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="m-portlet__body">


                        <div class="m-form m-form--label-align-right m--margin-top-20 m--margin-bottom-30" sec:authorize="hasAnyAuthority('PERM_ADD_INCOMEDOC')">
                            <div class="row align-items-center">
                                <div class="col-12 m--align-right">

                                    <span th:if="${type=='incoming'}" th:each="dst : ${documentSubTypes}">
                                        <a th:href="@{/doc/new/__${dst.internalName}__}" class="btn btn-success" th:text="${dst.name}"> New Document </a>
                                    </span>

                                    <div class="m-separator m-separator--dashed d-xl-none"></div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <th:block th:replace="doc/layout::__${type + 'Index'}__"/>

                        <!--table class="table table-bordered table-hover" id="incoming">
                            <thead class="thead-default">
                                <tr>
                                    <th width="30px"></th>
                                    <th width="30px"></th>
                                    <th width="120px">К</th>
                                    <th width="80px">Вхд. №</th>
                                    <th width="120px">Вхд. Дата</th>
                                    <th width="120px">Исх. № и Дата</th>
                                    <th th:text="#{label.document.sender}">Отправитель</th>
                                    <th th:text="#{label.document.title}">Относительно</th>
                                    <th width="330px" th:text="#{label.document.receiver}">Исполнитель</th>
                                    <th width="150px" th:text="#{label.document.generalStatus}">Состояние</th>
                                </tr>
                            </thead>
                        </table-->
                        <hr>

                    </div>
                    <div class="m-portlet__foot">
                        <span th:if="${type!='incoming'}" th:each="dst : ${documentSubTypes}">
                            <a th:href="@{/doc/new/__${dst.internalName}__}" class="btn btn-success" th:text="${dst.name}"> New Document </a>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- begin::Footer -->
    <div th:replace="layout/footer"/>
    <!-- end::Footer -->
</div>

<div th:replace="fragments/footer :: footer-js"/>

<script th:src="@{/assets/global/plugins/datatables/datatables.js}" type="text/javascript"></script>

<script type="text/javascript" th:inline="javascript">

    $(".openact").click(function(event) {

        event.preventDefault();

        $.ajax({
            url: $(this).attr('href'),
            success: function(response) {
                alert(response);
                location.reload();
            }
        });

        return false;
    });

    function format ( d ) {
        return  'Content : ' + d.title + '<br>';
    }

    $(document).ready(function()
    {
        var dtOptions = {
            stateSave: true,
            info: true,
            language: {
                lengthMenu: 'Показать <select>'+
                        '<option value="10">10</option>'+
                        '<option value="25">25</option>'+
                        '<option value="50">50</option>'+
                        '<option value="100">100</option>'+
                        '<option value="-1">Все</option>'+
                        '</select>',
                emptyTable: "<center>Нет данных</center>",
                search: "&nbsp;Поиск : &nbsp; ",
                zeroRecords: "",
                info: "Всего _TOTAL_ записей",
                paginate: {
                    first: '<i class="la la-angle-double-left"></i>',
                    previous: '<i class="la la-angle-left"></i>',
                    next: '<i class="la la-angle-right"></i>',
                    last: '<i class="la la-angle-double-right"></i>'
                }
            },
            dom: "<'row'<'col-6'i><'col-6'l>>" +
            "<'row'<'col-sm-12'tr>>" +
            "<'row'<'col-4'i><'col-4'p><'col-4'l>>",
            "deferRender": true,
            /*
            "ajax": {
                url: "doc/documentList",
                "dataSrc": ""
            },

            columns: [
                {
                    class: "details-control",
                    searchable: false,
                    orderable: false,
                    data: null,
                    defaultContent: ""
                },
                {
                    searchable: false,
                    orderable: false,
                    data: function (data, type, full, meta) {
                        return "...";
                    }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'documentDueDate',
                    data: 'documentDueDate',
                    render: function (data, type, full, meta) {
                        return data.documentDueDate !== null ? '<span class="text-danger">KОНТРОЛЬ<br>' + data.documentDueDate + '</span>' : '';

                    }
                },
                {
                    searchable: true,
                    orderable: true,
                    name: 'docIndex',
                    data: 'receiverRegisteredNumber',
                    render: function (data) { return data; }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'receiverRegisteredDate',
                    data: 'receiverRegisteredDate'
                },
                {
                    searchable: true,
                    orderable: true,
                    name: 'senderRegisteredNumber',
                    data: 'senderRegisteredNumber',
                    render: function (data, type, full, meta) {
                        return data.senderRegisteredNumber + "<hr>" + data.senderRegisteredDate;
                    }
                },
                {
                    searchable: false,
                    orderable: false,
                    name: 'senderResponsible',
                    data: 'senderResponsible',
                    render: function (data, type, full, meta) {
                        return data.senderResponsible !== null ? data.senderResponsible.join('') : null;
                    }
                },
                {
                    searchable: true,
                    orderable: false,
                    name: 'title',
                    data: 'title'
                },
                {
                    searchable: false,
                    orderable: false,
                    name: 'receiverResponsible',
                    data: 'receiverResponsible'
                        //function (data, type, full, meta) { return data.receiverResponsible !== null ? data.receiverResponsible.join('') : null; }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'documentState',
                    data: 'documentState'
                }
            ]
            */

        };
        var table = $('#documentTable').DataTable(dtOptions);

        /*
        <div class="m-input-icon m-input-icon--left">
            <input type="text" class="form-control m-input" th:placeholder="#{label.search}" id="generalSearch">
            <span class="m-input-icon__icon m-input-icon__icon--left">
                <span><i class="la la-search"></i></span>
            </span>
        </div>
        */
        /*
        var t1 = $('#incoming').DataTable({
            orderCellsTop: true,
            fixedHeader: true,
            searching: true,
            paging: true,
            processing: true,
            ajax: {
                url: '/doc/documents',
                data: function ( d ) {
                    d.documentType = [[${type}]];
                }
            },
            serverSide: true,
            order: [ [3, 'asc'] ],
            columns: [
                {
                    class: "details-control",
                    searchable: false,
                    orderable: false,
                    data: null,
                    defaultContent: ""
                },
                {
                    searchable: false,
                    orderable: false,
                    data: function (data, type, full, meta) {
                        return "...";
                    }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'documentDueDate',
                    data: function (data, type, full, meta) {
                        return data.documentDueDate !== null ? '<span class="text-danger">KОНТРОЛЬ<br>' + data.documentDueDate + '</span>' : '';

                    }
                },
                {
                    searchable: true,
                    orderable: true,
                    name: 'docIndex',
                    data: 'receiverRegisteredNumber',
                    render: function (data) { return data; }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'receiverRegisteredDate',
                    data: function (data, type, full, meta) {
                        return data.receiverRegisteredDate;

                    }
                },
                {
                    searchable: true,
                    orderable: true,
                    name: 'senderRegisteredNumber',
                    data: function (data, type, full, meta) {
                        return data.senderRegisteredNumber + "<hr>" + data.senderRegisteredDate;

                    }
                },
                {
                    searchable: false,
                    orderable: false,
                    name: 'senderResponsible',
                    data: function (data, type, full, meta) {
                        var r = [];

                        if(data.senderResponsible !== null) {


                            if (data.senderResponsible.organizations != null) {
                                data.senderResponsible.organizations.forEach(function (element) {
                                    r.push(element.name)
                                });
                            }

                            if (data.senderResponsible.person != null) {
                                data.senderResponsible.person.forEach(function (element) {
                                    r.push(element.name)
                                });
                            }
                        }

                        return r.join('');
                    }
                },
                {
                    searchable: true,
                    orderable: false,
                    name: 'title',
                    data: 'title'
                },
                {
                    searchable: false,
                    orderable: false,
                    name: 'receiverResponsible',
                    data: function (data, type, full, meta) {

                        var r = [];

                        data.receiverResponsible.staff.forEach(function(element) {
                            r.push(element.name + '<br>')
                        });

                        return r.join('');
                    }
                },
                {
                    searchable: false,
                    orderable: true,
                    name: 'documentState',
                    data: function (data, type, full, meta) {
                        return data.documentState === "REGISTERED" || data.documentState === "DONE" ? "Зарегистрирован" : "";
                    }
                }
            ],
            language: {
                emptyTable: "<center>Нет данных</center>",
                info: "Всего _TOTAL_ записей",
                lengthMenu: "_MENU_",
                paginate: {
                    first: '<i class="la la-angle-double-left"></i>',
                    previous: '<i class="la la-angle-left"></i>',
                    next: '<i class="la la-angle-right"></i>',
                    last: '<i class="la la-angle-double-right"></i>'
                }
            },
            dom: "<'row'<'col-6'i><'col-6'l>>" +
            "<'row'<'col-sm-12'tr>>" +
            "<'row'<'col-4'i><'col-4'p><'col-4'l>>"
        });

        var detailRows = [];

        $('#incoming tbody').on( 'click', 'tr td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = t1.row( tr );
            var idx = $.inArray( tr.attr('id'), detailRows );

            if ( row.child.isShown() ) {
                tr.removeClass( 'details' );
                row.child.hide();

                // Remove from the 'open' array
                detailRows.splice( idx, 1 );
            }
            else {
                tr.addClass( 'details' );
                row.child( format( row.data() ) ).show();

                // Add to the 'open' array
                if ( idx === -1 ) {
                    detailRows.push( tr.attr('id') );
                }
            }
        } );

        t1.on( 'draw', function () {
            $.each( detailRows, function ( i, id ) {
                $('#'+id+' td.details-control').trigger( 'click' );
            } );
        } );

        /*
        $('#ddt thead tr').clone(true).appendTo( '#ddt thead' );
        $('#ddt thead tr:eq(1) th').each( function (i) {

            $(this).html('<input type="text" class="form-control m-input m-input--solid">');
            $('input', this).on('keyup change', function (){

                if (this.value.length > 2 && table.column(i).search() !== this.value) {
                    table.column(i)
                        .search(this.value)
                        .draw();
                }
            });
        });
        */
        /*
        l - perpage
        r - processing
        t - table
        i - info
        p - paging
        f - filter
        */


        $('#generalSearch').keyup(function(){
            table.search($(this).val()).draw() ;
        });
    });

</script>

</body>
<!-- end::Body -->
</html>

